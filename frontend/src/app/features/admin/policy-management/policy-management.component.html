<div>
  <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
    <h2 class="text-2xl text-gray-900">Policy Templates</h2>
    <button
      (click)="openCreateModal()"
      class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      Create New Template
    </button>
  </div>

  <div *ngIf="feedbackMessage" class="bg-green-50 border border-green-200 text-green-800 rounded p-4 mb-6">
    {{ feedbackMessage }}
  </div>

  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex gap-2 flex-wrap">
      <button
        *ngFor="let option of policyTypes"
        (click)="setFilter(option.value)"
        class="px-4 py-2 rounded"
        [ngClass]="filterType === option.value
          ? 'bg-blue-600 text-white'
          : 'bg-white text-gray-700 border border-gray-300'">
        {{ option.label }}
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="bg-white rounded-lg shadow p-6 text-center text-gray-600">
    Loading policy templates...
  </div>

  <div *ngIf="error" class="bg-red-50 border border-red-200 text-red-700 rounded p-4">
    {{ error }}
  </div>

  <div *ngIf="!loading && !error && filteredPolicies.length === 0" class="bg-white rounded-lg shadow p-8 text-center">
    <p class="text-gray-600">No policy templates found.</p>
  </div>

  <div *ngIf="!loading && !error && filteredPolicies.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div *ngFor="let policy of filteredPolicies" class="bg-white rounded-lg shadow p-6 border border-gray-200">
      <div class="flex justify-between items-start mb-4">
        <div>
          <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm mb-2">
            {{ policy.type }}
          </span>
          <h3 class="text-xl text-gray-900">{{ policy.name }}</h3>
        </div>
        <span class="px-3 py-1 rounded text-sm" [ngClass]="getStatusBadgeClass(policy)">
          {{ policy.active ? 'Active' : 'Inactive' }}
        </span>
      </div>

      <p class="text-gray-600 text-sm mb-4">{{ policy.description }}</p>

      <div class="space-y-2 mb-4 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Coverage:</span>
          <span class="text-gray-900">{{ policy.coverage }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Duration:</span>
          <span class="text-gray-900">{{ policy.duration }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Price:</span>
          <span class="text-gray-900">${{ policy.price }}/month</span>
        </div>
      </div>

      <div class="border-t border-gray-200 pt-4 flex gap-2 flex-wrap">
        <button
          (click)="toggleActive(policy)"
          class="flex-1 px-3 py-2 rounded text-sm"
          [ngClass]="policy.active
            ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200'
            : 'bg-green-100 text-green-800 hover:bg-green-200'">
          {{ policy.active ? 'Deactivate' : 'Activate' }}
        </button>
        <button
          (click)="openEditModal(policy)"
          class="flex-1 px-3 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 text-sm">
          Edit
        </button>
        <button
          (click)="openDeleteDialog(policy)"
          class="flex-1 px-3 py-2 bg-red-100 text-red-800 rounded hover:bg-red-200 text-sm">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div *ngIf="showEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 my-8">
      <h3 class="text-xl text-gray-900 mb-4">Edit Policy Template</h3>
      <form [formGroup]="policyForm" (ngSubmit)="submitEdit()">
        <ng-container *ngTemplateOutlet="policyFormFields"></ng-container>
        <div class="flex gap-3 mt-6">
          <button
            type="button"
            (click)="closeModals()"
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50"
            [disabled]="submitting">
            Cancel
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400"
            [disabled]="submitting">
            {{ submitting ? 'Saving...' : 'Update Template' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Modal -->
  <div *ngIf="showCreateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 my-8">
      <h3 class="text-xl text-gray-900 mb-4">Create New Policy Template</h3>
      <form [formGroup]="policyForm" (ngSubmit)="submitCreate()">
        <ng-container *ngTemplateOutlet="policyFormFields"></ng-container>
        <div class="flex gap-3 mt-6">
          <button
            type="button"
            (click)="closeModals()"
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50"
            [disabled]="submitting">
            Cancel
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400"
            [disabled]="submitting">
            {{ submitting ? 'Saving...' : 'Create Template' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Dialog -->
  <div *ngIf="showDeleteDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-xl text-gray-900 mb-4">Delete Policy Template?</h3>
      <p class="text-gray-600 mb-6">
        Are you sure you want to permanently delete "{{ selectedPolicy?.name }}"?
        This action cannot be undone.
      </p>
      <div class="flex gap-3">
        <button
          type="button"
          (click)="closeModals()"
          class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50"
          [disabled]="submitting">
          Cancel
        </button>
        <button
          type="button"
          (click)="confirmDelete()"
          class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:bg-gray-400"
          [disabled]="submitting">
          {{ submitting ? 'Deleting...' : 'Delete Permanently' }}
        </button>
      </div>
    </div>
  </div>

  <ng-template #policyFormFields>
    <div class="mb-4">
      <label class="block text-sm text-gray-700 mb-2">Name</label>
      <input
        type="text"
        formControlName="name"
        class="w-full px-3 py-2 border border-gray-300 rounded"
        [class.border-red-500]="policyForm.get('name')?.invalid && policyForm.get('name')?.touched" />
      <p class="text-sm text-red-600 mt-1" *ngIf="policyForm.get('name')?.invalid && policyForm.get('name')?.touched">
        Name is required.
      </p>
    </div>

    <div class="mb-4">
      <label class="block text-sm text-gray-700 mb-2">Type</label>
      <select formControlName="type" class="w-full px-3 py-2 border border-gray-300 rounded">
        <option value="LIFE">Life</option>
        <option value="TRAVEL">Travel</option>
        <option value="PROPERTY">Property</option>
        <option value="HEALTH">Health</option>
      </select>
    </div>

    <div class="mb-4">
      <label class="block text-sm text-gray-700 mb-2">Coverage</label>
      <input
        type="text"
        formControlName="coverage"
        class="w-full px-3 py-2 border border-gray-300 rounded"
        [class.border-red-500]="policyForm.get('coverage')?.invalid && policyForm.get('coverage')?.touched" />
      <p class="text-sm text-red-600 mt-1" *ngIf="policyForm.get('coverage')?.invalid && policyForm.get('coverage')?.touched">
        Coverage is required.
      </p>
    </div>

    <div class="mb-4">
      <label class="block text-sm text-gray-700 mb-2">Duration</label>
      <input
        type="text"
        formControlName="duration"
        class="w-full px-3 py-2 border border-gray-300 rounded"
        [class.border-red-500]="policyForm.get('duration')?.invalid && policyForm.get('duration')?.touched" />
      <p class="text-sm text-red-600 mt-1" *ngIf="policyForm.get('duration')?.invalid && policyForm.get('duration')?.touched">
        Duration is required.
      </p>
    </div>

    <div class="mb-4">
      <label class="block text-sm text-gray-700 mb-2">Price (per month)</label>
      <input
        type="number"
        step="0.01"
        min="0"
        formControlName="price"
        class="w-full px-3 py-2 border border-gray-300 rounded"
        [class.border-red-500]="(policyForm.get('price')?.invalid && policyForm.get('price')?.touched) || policyForm.get('price')?.hasError('invalidPrice')" />
      <p class="text-sm text-red-600 mt-1" *ngIf="policyForm.get('price')?.invalid && policyForm.get('price')?.touched">
        Price is required.
      </p>
      <p class="text-sm text-red-600 mt-1" *ngIf="policyForm.get('price')?.hasError('invalidPrice')">
        Enter a valid price greater than zero.
      </p>
    </div>

    <div>
      <label class="block text-sm text-gray-700 mb-2">Description</label>
      <textarea
        formControlName="description"
        rows="4"
        class="w-full px-3 py-2 border border-gray-300 rounded"
        [class.border-red-500]="policyForm.get('description')?.invalid && policyForm.get('description')?.touched"></textarea>
      <p class="text-sm text-red-600 mt-1" *ngIf="policyForm.get('description')?.invalid && policyForm.get('description')?.touched">
        Description should be at least 10 characters.
      </p>
    </div>
  </ng-template>
</div>
